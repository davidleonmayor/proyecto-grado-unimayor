# Auth Repository — `src/auth/`

Authentication module: endpoints, patterns, and conventions.

## References

| Resource | Description | Path |
|----------|-------------|------|
| Prisma schema | Database models (`persona`, `actores`, `tipo_rol`) | `backend/prisma/schema.prisma` |
| Global middleware | AuthMiddleware, RoleMiddleware, errorHandler | `backend/src/common/middleware/` |
| Email templates | Brevo transactional emails (confirmation, password reset) | `backend/src/email/AuthEmail.ts` |
| Rate limiter | Auth-specific rate limit (15 req / 15 min) | `backend/src/config/limiter.ts` |

## Directory Structure

```
src/auth/
├── auth.routes.ts              # Route definitions — mounted at /api/auth
├── auth.controller.ts          # Request handlers (register, login, password flows)
├── auth.service.ts             # Business logic (createUser, findUserByEmail)
├── auth.schema.ts              # express-validator schemas per endpoint
├── interfaces/
│   └── authRequest.interface.ts    # Extended Request type with user property
├── middlewares/
│   └── validateJwt.ts          # JWT validation (module-local, currently empty)
├── utils/
│   ├── jwt.ts                  # generateJWT({ id, email }) — 6h expiry
│   ├── generateJwt.ts          # generateJWT(uid) — 24h expiry (alternative)
│   ├── password.ts             # hashPassword(), checkPassword() via bcrypt
│   └── __tests__/
│       └── password.test.ts
└── __tests__/
    ├── auth.controller.test.ts # Integration tests with supertest
    └── auth.service.test.ts    # Unit tests with jest mocks
```

## API Endpoints

All routes under `/api/auth`. Rate-limited: 15 requests per 15 min (skips successful).

### Public Routes

| Method | Path | Schema | Description |
|--------|------|--------|-------------|
| POST | `/register` | `RegisterSchema` | Create account, returns confirmation token |
| POST | `/confirm-account` | `UserConfirmationSchema` | Confirm with 6-digit token |
| POST | `/login` | `UserLoginSchema` | Returns JWT as plain string |
| POST | `/forgot-password` | `ForgotPasswordSchema` | Sends reset email via Brevo |
| POST | `/validate-token` | `ValidateTokenSchema` | Check if reset token is valid |
| POST | `/reset-password/:token` | `ResetPasswordSchema` | Set new password with token |

### Private Routes (require `AuthMiddleware.isAuthenticatedUser`)

| Method | Path | Schema | Description |
|--------|------|--------|-------------|
| GET | `/user` | — | Get current user (excludes password) |
| POST | `/reset-auth-password` | `UpdatePasswordSchema` | Change password (requires current) |
| POST | `/check-password` | `CheckAuthUserPasswordSchema` | Verify current password |

## Critical Patterns

### Route → Schema → Controller Flow

Every route uses `validateSchema()` before the controller:

```typescript
this.router.post(
    "/register",
    validateSchema(RegisterSchema),
    this.authController.register,
);
```

### Controller Binding

All controller methods are bound in the constructor to preserve `this`:

```typescript
constructor() {
    this.authService = new AuthService();
    this.register = this.register.bind(this);
    this.login = this.login.bind(this);
    // ...
}
```

### Request Interface

Auth controller uses a custom Request type that includes `user`:

```typescript
import type { Request } from "./interfaces/auth-request.interface";
// Request.user is of type User (full Prisma persona)
```

### Password Handling

- Hashing: `bcrypt.hash(password, salt=10)`
- Comparison: `bcrypt.compare(password, hash)`
- Import: `import { hashPassword, checkPassword } from "./utils/password"`

### JWT Generation

Two JWT generators exist in `utils/`:

| File | Payload | Expiry | Used by |
|------|---------|--------|---------|
| `jwt.ts` | `{ id, email }` | 6h | `auth.controller.ts` (login) |
| `generate-jwt.ts` | `{ uid }` | 24h | Legacy / alternative |

### Confirmation Token

6-digit numeric token generated by `common/utils/createToken.ts`:

```typescript
Math.floor(100000 + Math.random() * 900000).toString()
```

Stored in `persona.token` column, cleared on confirmation.

### Validation Schemas

Defined in `auth.schema.ts` using express-validator `Schema` type:

| Schema | Validates |
|--------|-----------|
| `RegisterSchema` | names, lastNames, typeOfDentityDocument, idDocumentNumber, phoneNumber, email, password |
| `UserLoginSchema` | email, password |
| `UserConfirmationSchema` | token (6 chars) |
| `ForgotPasswordSchema` | email |
| `ValidateTokenSchema` | token (6 chars) |
| `ResetPasswordSchema` | token (params), password, confirmPassword |
| `UpdatePasswordSchema` | authorization header, currentPassword, password, confirmPassword |
| `CheckAuthUserPasswordSchema` | authorization header, password |

Password validation rule: min 8 chars, 1 uppercase, 1 lowercase, 1 digit, 1 special char.

### Test Patterns

Tests use `jest.mock()` for prisma and utilities, `supertest` for HTTP:

```typescript
jest.mock('@backend/config/prisma', () => ({
  prisma: { persona: { findUnique: jest.fn(), create: jest.fn() } }
}));

const server = new Server();
const app = server['app'];

const response = await request(app)
    .post('/api/auth/login')
    .send({ email, password });
```

## Commands

```bash
pnpm test                              # Run all tests
pnpm test -- --testPathPattern=auth    # Run auth tests only
```
